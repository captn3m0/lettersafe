/*
 PSON (c) 2013 Daniel Wirtz <dcode@dcode.io>
 Released under the Apache License, Version 2.0
 see: https://github.com/dcodeIO/PSON for details
*/
(function(k){function n(k){if(!k)throw Error("PSON requires ByteBuffer.js: Get it at https://github.com/dcodeIO/ByteBuffer.js");var e={T:{ZERO:0,MAX:239,NULL:240,TRUE:241,FALSE:242,EOBJECT:243,EARRAY:244,ESTRING:245,OBJECT:246,ARRAY:247,INTEGER:248,LONG:249,FLOAT:250,DOUBLE:251,STRING:252,STRING_ADD:253,STRING_GET:254,BINARY:255}};e.Encoder=function(f,c){var e=new f(4);e.length=4;var g=f.Long,a=function(b,d){this.dict={};this.next=0;if(b&&Array.isArray(b))for(;this.next<b.length;)this.dict[b[this.next]]=
this.next++;this.progressive=!!d};a.prototype.encode=function(b,d){d||(d=new f);var c=d.littleEndian;try{return this._encodeValue(b,d.LE()),d.littleEndian=c,d}catch(a){throw d.littleEndian=c,a;}};a.prototype._encodeValue=function(b,d,a){if(null===b)d.writeUint8(c.NULL);else switch(typeof b){case "function":b=b.toString();case "string":0==b.length?d.writeUint8(c.ESTRING):this.dict.hasOwnProperty(b)?(d.writeUint8(c.STRING_GET),d.writeVarint32(this.dict[b])):(d.writeUint8(c.STRING),d.writeVString(b));
break;case "number":a=parseInt(b);b===a?(a=f.zigZagEncode32(b),a<=c.MAX?d.writeUint8(a):(d.writeUint8(c.INTEGER),d.writeZigZagVarint32(b))):(e.writeFloat32(b,0),b===e.readFloat32(0)?(d.writeUint8(c.FLOAT),d.writeFloat32(b)):(d.writeUint8(c.DOUBLE),d.writeFloat64(b)));break;case "boolean":d.writeUint8(b?c.TRUE:c.FALSE);break;case "object":var h;if(Array.isArray(b))if(0==b.length)d.writeUint8(c.EARRAY);else for(d.writeUint8(c.ARRAY),d.writeVarint32(b.length),h=0;h<b.length;h++)this._encodeValue(b[h],
d);else if(g&&b instanceof g)d.writeUint8(c.LONG),d.writeZigZagVarint64(b);else try{b=f.wrap(b),d.writeUint8(c.BINARY),d.writeVarint32(b.remaining()),d.append(b)}catch(k){var m=Object.keys(b),l=0;for(h=0;h<m.length;h++)"undefined"!==typeof b[m[h]]&&l++;if(0===l)d.writeUint8(c.EOBJECT);else for(d.writeUint8(c.OBJECT),d.writeVarint32(l),a||(a=!!b._PSON_EXCL_),h=0;h<m.length;h++)l=m[h],"undefined"!==typeof b[l]&&(this.dict.hasOwnProperty(l)?(d.writeUint8(c.STRING_GET),d.writeVarint32(this.dict[l])):
(this.progressive&&!a?(this.dict[l]=this.next++,d.writeUint8(c.STRING_ADD)):d.writeUint8(c.STRING),d.writeVString(l)),this._encodeValue(b[l],d))}break;case "undefined":d.writeUint8(c.NULL)}};return a}(k,e.T);e.Decoder=function(f,c){var e=f.Long,g=function(a,b){this.dict=a&&Array.isArray(a)?a:[];this.progressive=!!b};g.prototype.decode=function(a){a instanceof f||(a=f.wrap(a));var b=a.littleEndian;try{var c=this._decodeValue(a.LE());a.littleEndian=b;return c}catch(e){throw a.littleEndian=b,e;}};g.prototype._decodeValue=
function(a){var b=a.readUint8();if(b<=c.MAX)return f.zigZagDecode32(b);switch(b){case c.NULL:return null;case c.TRUE:return!0;case c.FALSE:return!1;case c.EOBJECT:return{};case c.EARRAY:return[];case c.ESTRING:return"";case c.OBJECT:for(var b=a.readVarint32(),d={};0<=--b;)d[this._decodeValue(a)]=this._decodeValue(a);return d;case c.ARRAY:b=a.readVarint32();for(d=[];0<=--b;)d.push(this._decodeValue(a));return d;case c.INTEGER:return a.readZigZagVarint32();case c.LONG:return e?a.readZigZagVarint64():
a.readZigZagVarint32();case c.FLOAT:return a.readFloat32();case c.DOUBLE:return a.readFloat64();case c.STRING:return a.readVString();case c.STRING_ADD:return a=a.readVString(),this.dict.push(a),a;case c.STRING_GET:return this.dict[a.readVarint32()];case c.BINARY:return b=a.readVarint32(),d=a.slice(a.offset,a.offset+b),a.offset+=b,d;default:throw Error("Illegal type at "+a.offset+": "+b);}};return g}(k,e.T);e.Pair=function(){var f=function(){};f.prototype.encode=function(c){return this.encoder.encode(c)};
f.prototype.toArrayBuffer=function(c){return this.encoder.encode(c).toArrayBuffer()};f.prototype.toBuffer=function(c){return this.encoder.encode(c).toBuffer()};f.prototype.decode=function(c){return this.decoder.decode(c)};return f}();e.StaticPair=function(f,c,e){var g=function(a){f.call(this);this.encoder=new c(a,!1);this.decoder=new e(a,!1)};g.prototype=Object.create(f.prototype);return g}(e.Pair,e.Encoder,e.Decoder);e.ProgressivePair=function(f,c,k){var g=function(a){f.call(this);this.encoder=new c(a,
!0);this.decoder=new k(a,!0)};g.prototype=Object.create(f.prototype);g.prototype.exclude=function(a){e.exclude(a)};g.prototype.include=function(a){e.include(a)};return g}(e.Pair,e.Encoder,e.Decoder);e.exclude=function(e){"object"===typeof e&&Object.defineProperty(e,"_PSON_EXCL_",{value:!0,enumerable:!1,configurable:!0})};e.include=function(e){"object"===typeof e&&delete e._PSON_EXCL_};return e}"undefined"!=typeof module&&module.exports?module.exports=n(require("bytebuffer")):"undefined"!=typeof define&&
define.amd?define("PSON",["ByteBuffer"],n):(k.dcodeIO||(k.dcodeIO={}),k.dcodeIO.PSON=n(k.dcodeIO.ByteBuffer))})(this);
